<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&#x2694LRM&#x2694</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        canvas {
            border: 1px solid #000;
            max-width: 100%;
        }

        .page-text {
            font-family: 'Courier New', monospace;
            text-align: left;
            margin-bottom: 5px;
            border-bottom: 1px solid #555;
        }

        .page-header {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: darkgrey;
            text-align: left;
            margin-bottom: 5px;
        }

        .tap-list {
            margin-top: 10px;
            padding: 10px;
            background-color: #333;
            border-radius: 5px;
        }

        .tap-list h4 {
            margin: 0 0 5px 0;
            color: darkgrey;
            font-size: 0.9em;
        }

        .tap-list ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: disc;
            columns: 2;
        }

        .tap-list li {
            font-size: 0.9em;
            color: darkgrey;
        }
    </style>
</head>

<body>
    <script type=module src=../main.js></script>
    <div class="wrapper-wide">
        <main>
            
            <h1>
                PDF Reader
                <br>
            </h1>

            <div class="container-horizontal" style="min-height: 90vh; max-height: 90vh;">
                <div class="container-vertical">
                    <div class="page-section flex-fill">
                        <input type="file" id="fileInput" accept=".pdf" />
                        <canvas id="pdf-render"></canvas>
                        <div class="form-group">
                            <button id="prevPage">Previous</button>
                            <span id="pageInfo">Page <span id="pageNum">--</span> of <span id="pageCount">--</span></span>
                            <button id="nextPage">Next</button>
                        </div>
                    </div>
                </div>
                <div class="container-vertical">
                    <div class="page-section flex-fill" id="text-output">
                        <p>Upload a PDF to see extracted text here.</p>
                    </div>
                </div>
            </div>

        </main>
        <my-footer></my-footer>
    </div>

    <script>
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        const scale = 1.5;
        const canvas = document.getElementById('pdf-render');
        const ctx = canvas.getContext('2d');

        // Render the page
        function renderPage(num) {
            pageRendering = true;

            // Fetch page
            pdfDoc.getPage(num).then(function (page) {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page into canvas context
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                const renderTask = page.render(renderContext);

                // Wait for render to finish
                renderTask.promise.then(function () {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            // Update page counters
            document.getElementById('pageNum').textContent = num;
        }

        // Queue rendering of the next page
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        // Previous page
        function onPrevPage() {
            if (pageNum <= 1) {
                return;
            }
            pageNum--;
            queueRenderPage(pageNum);
        }
        document.getElementById('prevPage').addEventListener('click', onPrevPage);

        // Next page
        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) {
                return;
            }
            pageNum++;
            queueRenderPage(pageNum);
        }
        document.getElementById('nextPage').addEventListener('click', onNextPage);

        function findTapSizes(text) {
            // Regex for:
            // Metric: M followed by digits, optional decimal (e.g., M3, M3.0, M12)
            // Unified Numbered: 1-2 digits, hyphen, 2-3 digits (e.g., 0-80, 4-40)
            // Unified Fractional: 1-2 digits, slash, 1-2 digits, hyphen, 2-3 digits (e.g., 1/4-20)
            const regex = /(?:\bM\d+(?:\.\d+)?|\b\d{1,2}-\d{2,3}\b|\b\d{1,2}\/\d{1,2}-\d{2,3}\b)/gi;
            const matches = text.match(regex);
            if (!matches) return [];
            // Return unique matches
            return [...new Set(matches)];
        }

        // Extract text from all pages
        async function extractText() {
            const textOutput = document.getElementById('text-output');
            textOutput.innerHTML = ''; // Clear previous text

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const textContent = await page.getTextContent();

                const pageTextDiv = document.createElement('div');
                pageTextDiv.className = 'page-text';

                const header = document.createElement('div');
                header.className = 'page-header';
                header.textContent = `Page ${i}`;
                pageTextDiv.appendChild(header);

                const textItems = textContent.items.map(item => item.str).join(' ');
                const content = document.createElement('p');
                content.textContent = textItems;
                pageTextDiv.appendChild(content);

                // Find and display tap sizes
                const tapSizes = findTapSizes(textItems);
                if (tapSizes.length > 0) {
                    const tapListDiv = document.createElement('div');
                    tapListDiv.className = 'tap-list';

                    const tapHeader = document.createElement('h4');
                    tapHeader.textContent = 'Found Tap Sizes:';
                    tapListDiv.appendChild(tapHeader);

                    const ul = document.createElement('ul');
                    tapSizes.forEach(size => {
                        const li = document.createElement('li');
                        li.textContent = size;
                        ul.appendChild(li);
                    });
                    tapListDiv.appendChild(ul);
                    pageTextDiv.appendChild(tapListDiv);
                }

                textOutput.appendChild(pageTextDiv);
            }
        }

        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file.');
                return;
            }

            const fileReader = new FileReader();
            fileReader.onload = function () {
                const typedarray = new Uint8Array(this.result);

                pdfjsLib.getDocument(typedarray).promise.then(function (pdfDoc_) {
                    pdfDoc = pdfDoc_;
                    document.getElementById('pageCount').textContent = pdfDoc.numPages;

                    // Initial/first page rendering
                    pageNum = 1;
                    renderPage(pageNum);

                    // Extract text
                    extractText();
                });
            };
            fileReader.readAsArrayBuffer(file);
        });
    </script>
</body>

</html>